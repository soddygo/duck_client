---
name: CLI-UI Build

on:
  push:
    branches: [main]
    paths:
      - 'cli-ui/**'
      - 'client-core/**'
      - '.github/workflows/cli-ui-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cli-ui/**'
      - 'client-core/**'
      - '.github/workflows/cli-ui-build.yml'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        default: false
        type: boolean

# æ·»åŠ å¿…è¦çš„æƒé™é…ç½®
permissions:
  contents: read
  actions: read

env:
  CARGO_TERM_COLOR: always
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  # å¿«é€Ÿæ£€æŸ¥ä»»åŠ¡
  check:
    name: Pre-build Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Rust code
        run: |
          cd cli-ui/src-tauri
          cargo check

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Check TypeScript
        run: |
          cd cli-ui
          npm run build

  # è·¨å¹³å°æž„å»ºä»»åŠ¡
  build:
    name: Build CLI-UI for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    needs: check
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux-x86_64
            os: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            arch: x64
            build_args: ""

          - name: Linux-aarch64
            os: ubuntu-22.04
            rust_target: aarch64-unknown-linux-gnu
            arch: arm64
            build_args: ""

          - name: Windows-x86_64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            arch: x64
            build_args: ""

          - name: Windows-aarch64
            os: windows-latest
            rust_target: aarch64-pc-windows-msvc
            arch: arm64
            build_args: ""

          - name: macOS-x86_64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            arch: x64
            build_args: ""

          - name: macOS-aarch64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            arch: arm64
            build_args: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å¹³å°ç‰¹å®šç³»ç»Ÿä¾èµ–å®‰è£…
      - name: Install Linux dependencies for Tauri
        if: startsWith(matrix.platform.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libglib2.0-dev \
            libgobject-2.0-dev \
            libgio-2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.0-dev \
            pkg-config \
            build-essential

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.platform.rust_target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: cli-ui/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('cli-ui/package-lock.json') }}

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Build duck-cli binary
        run: |
          # åªæž„å»º duck-cli æ¨¡å—ï¼Œé¿å…å…¶ä»–æ¨¡å—çš„ä¾èµ–é—®é¢˜
          cargo build --release --target ${{ matrix.platform.rust_target }} -p duck-cli
        shell: bash

      - name: Copy duck-cli binary to cli-ui (Tauri sidecar naming)
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p cli-ui/src-tauri/binaries
          
          # ä½¿ç”¨ Tauri è‡ªåŠ¨å‘½åçº¦å®šï¼šbinaries/duck-cli-$TARGET_TRIPLE
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            # Windows å¹³å° (.exe æ‰©å±•å)
            cp target/${{ matrix.platform.rust_target }}/release/duck-cli.exe \
               cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }}.exe
          else
            # macOS å’Œ Linux å¹³å° (æ— æ‰©å±•å)
            cp target/${{ matrix.platform.rust_target }}/release/duck-cli \
               cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }}
          fi
        shell: bash

      - name: Setup cross-compilation for Linux ARM64
        if: matrix.platform.rust_target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Verify duck-cli binary
        run: |
          echo "=== éªŒè¯ duck-cli äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          find cli-ui/src-tauri/binaries -name "duck-cli*" -type f | head -10
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la cli-ui/src-tauri/binaries/
        shell: bash

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          projectPath: cli-ui
          args: --target ${{ matrix.platform.rust_target }} ${{ matrix.platform.build_args }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-ui-${{ matrix.platform.name }}
          path: |
            cli-ui/src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/
          retention-days: 30

  # macOS é€šç”¨äºŒè¿›åˆ¶æž„å»ºï¼ˆå¯é€‰ï¼‰
  build-macos-universal:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    needs: build
    if: ${{ always() && (needs.build.result == 'success') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            x86_64-apple-darwin
            aarch64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Build duck-cli for macOS Universal
        run: |
          # æž„å»º x86_64 ç‰ˆæœ¬
          cargo build --release --target x86_64-apple-darwin -p duck-cli
          
          # æž„å»º aarch64 ç‰ˆæœ¬
          cargo build --release --target aarch64-apple-darwin -p duck-cli
          
          # åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨ Tauri å‘½åçº¦å®šï¼‰
          mkdir -p cli-ui/src-tauri/binaries
          lipo -create \
            target/x86_64-apple-darwin/release/duck-cli \
            target/aarch64-apple-darwin/release/duck-cli \
            -output cli-ui/src-tauri/binaries/duck-cli-universal-apple-darwin

      - name: Build universal macOS app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          projectPath: cli-ui
          args: --target universal-apple-darwin

      - name: Upload universal macOS build
        uses: actions/upload-artifact@v4
        with:
          name: cli-ui-macOS-universal
          path: |
            cli-ui/src-tauri/target/universal-apple-darwin/release/bundle/
          retention-days: 30

  # æž„å»ºæ‘˜è¦
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check, build, build-macos-universal]
    if: ${{ always() }}
    steps:
      - name: Generate build summary
        run: |
          echo "## CLI-UI Build Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-build checks: ${{ needs.check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-platform build: ${{ needs.build.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS Universal build: ${{ needs.build-macos-universal.result == 'success' && 'âœ… Completed' || needs.build-macos-universal.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux (x86_64, ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows (x86_64, ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ macOS (x86_64, ARM64, Universal)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Built applications can be found in the **Artifacts** section of this workflow run." >> $GITHUB_STEP_SUMMARY

          # å¦‚æžœæž„å»ºå¤±è´¥ï¼Œæ·»åŠ æ•…éšœæŽ’é™¤ä¿¡æ¯
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "- Check that all duck-cli binaries were downloaded correctly" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Tauri configuration is valid" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure all system dependencies are installed" >> $GITHUB_STEP_SUMMARY
            echo "- Check for Rust compilation errors" >> $GITHUB_STEP_SUMMARY
          fi 