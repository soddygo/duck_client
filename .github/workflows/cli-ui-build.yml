---
name: CLI-UI Build

on:
  push:
    branches: [main]
    paths:
      - 'cli-ui/**'
      - 'client-core/**'
      - '.github/workflows/cli-ui-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cli-ui/**'
      - 'client-core/**'
      - '.github/workflows/cli-ui-build.yml'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes detected'
        required: false
        default: false
        type: boolean

# æ·»åŠ å¿…è¦çš„æƒé™é…ç½®
permissions:
  contents: read
  actions: read

env:
  CARGO_TERM_COLOR: always
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  # å¿«é€Ÿæ£€æŸ¥ä»»åŠ¡
  check:
    name: Pre-build Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies for Rust check
        run: |
          echo "=== æ›´æ–° apt æº ==="
          sudo apt-get update
          
          echo "=== å®‰è£…åŸºç¡€å¼€å‘å·¥å…· ==="
          sudo apt-get install -y \
            curl \
            wget \
            file \
            build-essential \
            libc6-dev \
            m4 \
            pkg-config
          
          echo "=== å®‰è£… GLib å’Œç›¸å…³ç³»ç»Ÿåº“ ==="
          # æ³¨æ„ï¼šgobject-2.0 å’Œ gio-2.0 åŠŸèƒ½éƒ½åŒ…å«åœ¨ libglib2.0-dev ä¸­
          sudo apt-get install -y \
            libglib2.0-dev \
            libglib2.0-0 \
            libglib2.0-data \
            libglib2.0-bin \
            glib-networking \
            glib-networking-common \
            glib-networking-services
          
          echo "=== å®‰è£…å…¶ä»–å¿…è¦çš„ç³»ç»Ÿä¾èµ– ==="
          # åˆ†åˆ«å®‰è£…ä»¥ä¾¿æ›´å¥½åœ°è°ƒè¯•é”™è¯¯
          sudo apt-get install -y libssl-dev
          sudo apt-get install -y libgtk-3-dev
          
          # å°è¯•å®‰è£… WebKitï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
          echo "=== å°è¯•å®‰è£… WebKit å¼€å‘åŒ… ==="
          if ! sudo apt-get install -y libwebkit2gtk-4.0-dev; then
            echo "âš ï¸  libwebkit2gtk-4.0-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨åŒ…å"
            sudo apt-get install -y libwebkit2gtk-4.1-dev || echo "âŒ WebKit å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
          fi
          
          # å®‰è£… libsoup-3.0 (Tauri 2.0 éœ€è¦)
          echo "=== å®‰è£… libsoup-3.0 ==="
          if sudo apt-get install -y libsoup-3.0-dev; then
            echo "âœ… libsoup-3.0-dev å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ libsoup-3.0-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ"
            sudo apt-get install -y libsoup2.4-dev || echo "âŒ libsoup å®‰è£…å¤±è´¥"
          fi
          
          sudo apt-get install -y \
            librsvg2-dev \
            patchelf
          
          # å¤„ç†åº”ç”¨æŒ‡ç¤ºå™¨ä¾èµ–å†²çª
          echo "=== å®‰è£…åº”ç”¨æŒ‡ç¤ºå™¨ä¾èµ– ==="
          if sudo apt-get install -y libayatana-appindicator3-dev; then
            echo "âœ… ä½¿ç”¨ Ayatana åº”ç”¨æŒ‡ç¤ºå™¨"
          else
            echo "âš ï¸  Ayatana å®‰è£…å¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿç‰ˆæœ¬"
            sudo apt-get remove -y libayatana-appindicator3-dev 2>/dev/null || true
            sudo apt-get install -y libappindicator3-dev || echo "âŒ åº”ç”¨æŒ‡ç¤ºå™¨å®‰è£…å¤±è´¥"
          fi
          
          # å¼ºåˆ¶æ›´æ–°åº“ç¼“å­˜
          sudo ldconfig
          
          # è®¾ç½® PKG_CONFIG_PATH
          export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig"
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig" >> $GITHUB_ENV
          
          # éªŒè¯å…³é”®ä¾èµ–
          echo "=== æ£€æŸ¥é˜¶æ®µ GLib éªŒè¯ ==="
          pkg-config --exists glib-2.0 && echo "âœ… glib-2.0 found" || echo "âŒ glib-2.0 not found"
          pkg-config --exists gobject-2.0 && echo "âœ… gobject-2.0 found" || echo "âŒ gobject-2.0 not found"
          pkg-config --exists gio-2.0 && echo "âœ… gio-2.0 found" || echo "âŒ gio-2.0 not found"
          
          # éªŒè¯ Tauri 2.0 å…³é”®ä¾èµ–
          echo "=== Tauri 2.0 å…³é”®ä¾èµ–éªŒè¯ ==="
          pkg-config --exists libsoup-3.0 && echo "âœ… libsoup-3.0 found" || echo "âŒ libsoup-3.0 not found"
          pkg-config --exists webkit2gtk-4.1 && echo "âœ… webkit2gtk-4.1 found" || echo "âŒ webkit2gtk-4.1 not found"
          pkg-config --exists webkit2gtk-4.0 && echo "âœ… webkit2gtk-4.0 found" || echo "âŒ webkit2gtk-4.0 not found"
          pkg-config --exists javascriptcoregtk-4.1 && echo "âœ… javascriptcoregtk-4.1 found" || echo "âŒ javascriptcoregtk-4.1 not found"
          pkg-config --exists javascriptcoregtk-4.0 && echo "âœ… javascriptcoregtk-4.0 found" || echo "âŒ javascriptcoregtk-4.0 not found"
          
          # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "=== ä¾èµ–ç‰ˆæœ¬ä¿¡æ¯ ==="
          pkg-config --modversion glib-2.0 gobject-2.0 gio-2.0 2>/dev/null || echo "âŒ version check failed"
          pkg-config --modversion libsoup-3.0 2>/dev/null || echo "âš ï¸ libsoup-3.0 version check failed"
          pkg-config --modversion javascriptcoregtk-4.1 2>/dev/null || echo "âš ï¸ javascriptcoregtk-4.1 version check failed"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-check-${{ hashFiles('**/Cargo.lock') }}

      - name: Check Rust code
        run: |
          cd cli-ui/src-tauri
          cargo check
        env:
          PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig
          PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
          PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Check TypeScript
        run: |
          cd cli-ui
          npm run build

  # è·¨å¹³å°æž„å»ºä»»åŠ¡
  build:
    name: Build CLI-UI for ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    needs: check
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: Linux-x86_64
            os: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            arch: x64
            build_args: ""

          - name: Linux-aarch64
            os: ubuntu-22.04
            rust_target: aarch64-unknown-linux-gnu
            arch: arm64
            build_args: ""

          - name: Windows-x86_64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            arch: x64
            build_args: ""

          - name: Windows-aarch64
            os: windows-latest
            rust_target: aarch64-pc-windows-msvc
            arch: arm64
            build_args: ""

          - name: macOS-x86_64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            arch: x64
            build_args: ""

          - name: macOS-aarch64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            arch: arm64
            build_args: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å¹³å°ç‰¹å®šç³»ç»Ÿä¾èµ–å®‰è£…
      - name: Install Linux dependencies for Tauri 2.0
        if: startsWith(matrix.platform.os, 'ubuntu')
        run: |
          echo "=== æ›´æ–°åŒ…åˆ—è¡¨ ==="
          # æ·»åŠ é‡è¯•æœºåˆ¶å¤„ç†ç½‘ç»œé—®é¢˜
          for i in {1..3}; do
            echo "å°è¯• $i/3 æ¬¡æ›´æ–°åŒ…åˆ—è¡¨..."
            if sudo apt-get update; then
              echo "âœ… åŒ…åˆ—è¡¨æ›´æ–°æˆåŠŸ"
              break
            else
              echo "âš ï¸  åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep 10
              if [ $i -eq 3 ]; then
                echo "âŒ åŒ…åˆ—è¡¨æ›´æ–°æœ€ç»ˆå¤±è´¥ï¼Œä½¿ç”¨çŽ°æœ‰ç¼“å­˜ç»§ç»­"
              fi
            fi
          done
          
          # å…ˆå®‰è£…åŸºç¡€å¼€å‘å·¥å…·
          sudo apt-get install -y \
            curl \
            wget \
            file \
            build-essential \
            libc6-dev \
            m4 \
            pkg-config
          
          # å¦‚æžœæ˜¯ARM64æž„å»ºï¼Œæ·»åŠ å¤šæž¶æž„æ”¯æŒ
          if [[ "${{ matrix.platform.rust_target }}" == "aarch64-unknown-linux-gnu" ]]; then
            echo "=== è®¾ç½® ARM64 å¤šæž¶æž„æ”¯æŒ ==="
            sudo dpkg --add-architecture arm64
            
            echo "=== æ›´æ–°ARM64åŒ…åˆ—è¡¨ï¼ˆå…è®¸å¤±è´¥ï¼‰==="
            # å°è¯•æ›´æ–°åŒ…åˆ—è¡¨ï¼Œå¦‚æžœå¤±è´¥åˆ™ç»§ç»­ï¼ˆä½¿ç”¨çŽ°æœ‰ç¼“å­˜ï¼‰
            if ! sudo apt-get update 2>/dev/null; then
              echo "âš ï¸  ARM64 åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œä½¿ç”¨çŽ°æœ‰ç¼“å­˜ç»§ç»­"
              echo "   è¿™ä¸ä¼šå½±å“ä¸»è¦æž„å»ºè¿‡ç¨‹"
            else
              echo "âœ… ARM64 åŒ…åˆ—è¡¨æ›´æ–°æˆåŠŸ"
            fi
          fi
          
          # å®‰è£… GLib å’Œç›¸å…³ç³»ç»Ÿåº“ (å®Œæ•´åŒ…å«æ‰€æœ‰å¿…éœ€çš„ dev åŒ…)
          # æ³¨æ„ï¼šgobject-2.0 å’Œ gio-2.0 åŠŸèƒ½éƒ½åŒ…å«åœ¨ libglib2.0-dev ä¸­
          sudo apt-get install -y \
            libglib2.0-dev \
            libglib2.0-0 \
            libglib2.0-data \
            libglib2.0-bin \
            glib-networking \
            glib-networking-common \
            glib-networking-services
          
          # å¼ºåˆ¶æ›´æ–° pkg-config ç¼“å­˜
          sudo ldconfig
          
          # è®¾ç½® PKG_CONFIG_PATH çŽ¯å¢ƒå˜é‡ (å¯¹äºŽ x86_64)
          export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig"
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig" >> $GITHUB_ENV
          
          # éªŒè¯ä¸»è¦ GLib ä¾èµ–
          echo "=== ä¸»æœºæž¶æž„ GLib éªŒè¯ ==="
          pkg-config --exists glib-2.0 && echo "âœ… glib-2.0 found" || echo "âŒ glib-2.0 not found"
          pkg-config --exists gobject-2.0 && echo "âœ… gobject-2.0 found" || echo "âŒ gobject-2.0 not found"
          pkg-config --exists gio-2.0 && echo "âœ… gio-2.0 found" || echo "âŒ gio-2.0 not found"
          
          # éªŒè¯ Tauri 2.0 å…³é”®ä¾èµ–
          echo "=== Tauri 2.0 å…³é”®ä¾èµ–éªŒè¯ ==="
          pkg-config --exists libsoup-3.0 && echo "âœ… libsoup-3.0 found" || echo "âŒ libsoup-3.0 not found"
          pkg-config --exists webkit2gtk-4.1 && echo "âœ… webkit2gtk-4.1 found" || echo "âŒ webkit2gtk-4.1 not found"
          pkg-config --exists webkit2gtk-4.0 && echo "âœ… webkit2gtk-4.0 found" || echo "âŒ webkit2gtk-4.0 not found"
          pkg-config --exists javascriptcoregtk-4.1 && echo "âœ… javascriptcoregtk-4.1 found" || echo "âŒ javascriptcoregtk-4.1 not found"
          pkg-config --exists javascriptcoregtk-4.0 && echo "âœ… javascriptcoregtk-4.0 found" || echo "âŒ javascriptcoregtk-4.0 not found"
          
          # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
          echo "=== ä¾èµ–ç‰ˆæœ¬ä¿¡æ¯ ==="
          pkg-config --modversion glib-2.0 gobject-2.0 gio-2.0 2>/dev/null || echo "âŒ version check failed"
          pkg-config --modversion libsoup-3.0 2>/dev/null || echo "âš ï¸ libsoup-3.0 version check failed"
          pkg-config --modversion javascriptcoregtk-4.1 2>/dev/null || echo "âš ï¸ javascriptcoregtk-4.1 version check failed"
          
          # æ‰‹åŠ¨éªŒè¯å…³é”®çš„ .pc æ–‡ä»¶
          echo "=== éªŒè¯ä¸»æœºæž¶æž„ .pc æ–‡ä»¶ ==="
          ls -la /usr/lib/x86_64-linux-gnu/pkgconfig/ | grep -E "(glib|gobject|gio)" | head -5 || echo "âŒ x86_64 pc files not found"
          
          # å®‰è£…å®Œæ•´çš„ Tauri ä¾èµ–
          echo "=== å®‰è£…æ ¸å¿ƒ Tauri ä¾èµ– ==="
          sudo apt-get install -y \
            libssl-dev \
            libgtk-3-dev \
            librsvg2-dev \
            patchelf
          
          # å¤„ç†åº”ç”¨æŒ‡ç¤ºå™¨ä¾èµ–å†²çª - ä¼˜å…ˆä½¿ç”¨çŽ°ä»£çš„ Ayatana ç‰ˆæœ¬
          echo "=== å®‰è£…åº”ç”¨æŒ‡ç¤ºå™¨ä¾èµ– ==="
          if sudo apt-get install -y libayatana-appindicator3-dev; then
            echo "âœ… ä½¿ç”¨ Ayatana åº”ç”¨æŒ‡ç¤ºå™¨"
          else
            echo "âš ï¸  Ayatana å®‰è£…å¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿç‰ˆæœ¬"
            # æ¸…ç†å¯èƒ½çš„å†²çªåŒ…
            sudo apt-get remove -y libayatana-appindicator3-dev 2>/dev/null || true
            sudo apt-get install -y libappindicator3-dev || echo "âŒ åº”ç”¨æŒ‡ç¤ºå™¨å®‰è£…å¤±è´¥"
          fi
          
          echo "=== å°è¯•å®‰è£… WebKit å¼€å‘åŒ… ==="
          # å°è¯•å®‰è£… WebKit ä¾èµ–ï¼Œæ”¯æŒå¤šä¸ªç‰ˆæœ¬çš„å¤‡ç”¨æ–¹æ¡ˆ
          if sudo apt-get install -y libwebkit2gtk-4.1-dev; then
            echo "âœ… libwebkit2gtk-4.1-dev å®‰è£…æˆåŠŸ"
          elif sudo apt-get install -y libwebkit2gtk-4.0-dev; then
            echo "âœ… libwebkit2gtk-4.0-dev å®‰è£…æˆåŠŸ (å¤‡ç”¨æ–¹æ¡ˆ)"
          else
            echo "âŒ WebKit å¼€å‘åŒ…å®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
          fi
          
          echo "=== å®‰è£… JavaScriptCore GTK ==="
          # å®‰è£… JavaScriptCore GTK (Tauri 2.0 éœ€è¦ 4.1 ç‰ˆæœ¬)
          if sudo apt-get install -y libjavascriptcoregtk-4.1-dev; then
            echo "âœ… libjavascriptcoregtk-4.1-dev å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ libjavascriptcoregtk-4.1-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ç‰ˆæœ¬"
            sudo apt-get install -y libjavascriptcoregtk-4.0-dev || echo "âŒ JavaScriptCore å®‰è£…å¤±è´¥"
          fi
          
          echo "=== å®‰è£…å…¶ä»–å›¾å½¢å’Œåª’ä½“åº“ ==="
          # åˆ†ç»„å®‰è£…ï¼Œé¿å…æ½œåœ¨å†²çª
          sudo apt-get install -y \
            libxdo-dev \
            libcairo2-dev \
            libpango1.0-dev \
            libatk1.0-dev \
            libgdk-pixbuf-2.0-dev || echo "âš ï¸ éƒ¨åˆ†å›¾å½¢åº“å®‰è£…å¤±è´¥"
          
          # å®‰è£… libsoup-3.0 (Tauri 2.0 éœ€è¦)
          echo "=== å®‰è£… libsoup-3.0 ==="
          if sudo apt-get install -y libsoup-3.0-dev; then
            echo "âœ… libsoup-3.0-dev å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ libsoup-3.0-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ"
            sudo apt-get install -y libsoup2.4-dev || echo "âŒ libsoup å®‰è£…å¤±è´¥"
          fi
          
          # å®‰è£… JavaScriptCore GTK (Tauri 2.0 éœ€è¦ 4.1 ç‰ˆæœ¬)
          echo "=== å®‰è£… JavaScriptCore GTK ==="
          if sudo apt-get install -y libjavascriptcoregtk-4.1-dev; then
            echo "âœ… libjavascriptcoregtk-4.1-dev å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸ libjavascriptcoregtk-4.1-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ç‰ˆæœ¬"
            sudo apt-get install -y libjavascriptcoregtk-4.0-dev || echo "âŒ JavaScriptCore å®‰è£…å¤±è´¥"
          fi
          
          sudo apt-get install -y \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libgif-dev || echo "âš ï¸ éƒ¨åˆ†å›¾åƒåº“å®‰è£…å¤±è´¥"
          
          sudo apt-get install -y \
            libx11-dev \
            libxext-dev \
            libxft-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxrender-dev \
            libxfixes-dev \
            libxrandr-dev \
            libxss-dev \
            libxss1 || echo "âš ï¸ éƒ¨åˆ†X11åº“å®‰è£…å¤±è´¥"
          
          sudo apt-get install -y \
            libgconf-2-4 || echo "âš ï¸ GConfåº“å®‰è£…å¤±è´¥ï¼Œä½†ä¸å½±å“æž„å»º"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.rust_target }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.platform.rust_target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: cli-ui/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('cli-ui/package-lock.json') }}

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Setup cross-compilation for Linux ARM64
        if: matrix.platform.rust_target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "=== è®¾ç½® ARM64 äº¤å‰ç¼–è¯‘ ==="
          
          # å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼ˆå…è®¸å¤±è´¥ï¼‰
          echo "=== æ›´æ–°åŒ…åˆ—è¡¨ï¼ˆARM64 äº¤å‰ç¼–è¯‘ï¼‰ ==="
          if ! sudo apt-get update 2>/dev/null; then
            echo "âš ï¸  åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨çŽ°æœ‰ç¼“å­˜"
          fi
          
          echo "=== å®‰è£… ARM64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ==="
          if sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            libc6-dev-arm64-cross 2>/dev/null; then
            echo "âœ… ARM64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸  ARM64 äº¤å‰ç¼–è¯‘å·¥å…·é“¾å®‰è£…å¤±è´¥"
            echo "   å°†å›žé€€åˆ°ä½¿ç”¨ä¸»æœºæž¶æž„è¿›è¡Œæž„å»º"
            echo "   ç”Ÿæˆçš„binaryå¯èƒ½ä¸æ˜¯åŽŸç”ŸARM64ï¼Œä½†æž„å»ºå¯ä»¥ç»§ç»­"
          fi
          
          # å°è¯•å®‰è£… ARM64 ç‰¹å®šçš„å¼€å‘åŒ…ï¼ˆå…è®¸å¤±è´¥ï¼‰
          echo "=== å°è¯•å®‰è£… ARM64 å¼€å‘åŒ…ï¼ˆå¯é€‰ï¼‰ ==="
          echo "æ³¨æ„ï¼šARM64 åŒ…å®‰è£…å¤±è´¥ä¸ä¼šå½±å“æž„å»ºï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„çš„å¤´æ–‡ä»¶"
          
          # å®‰è£… ARM64 GLib å¼€å‘åŒ…
          echo "=== å®‰è£… ARM64 GLib ä¾èµ– ==="
          if sudo apt-get install -y libglib2.0-dev:arm64 2>/dev/null; then
            echo "âœ… ARM64 GLib åŒ…å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸  ARM64 GLib åŒ…å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„çš„å¤´æ–‡ä»¶"
          fi
          
          # å®‰è£… ARM64 libsoup-3.0
          echo "=== å®‰è£… ARM64 libsoup-3.0 ==="
          if sudo apt-get install -y libsoup-3.0-dev:arm64 2>/dev/null; then
            echo "âœ… ARM64 libsoup-3.0 åŒ…å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸  ARM64 libsoup-3.0 åŒ…å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„çš„åº“"
          fi
          
          # å®‰è£… ARM64 JavaScriptCore GTK
          echo "=== å®‰è£… ARM64 JavaScriptCore GTK ==="
          if sudo apt-get install -y libjavascriptcoregtk-4.1-dev:arm64 2>/dev/null; then
            echo "âœ… ARM64 JavaScriptCore GTK åŒ…å®‰è£…æˆåŠŸ"
          else
            echo "âš ï¸  ARM64 JavaScriptCore GTK åŒ…å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„çš„åº“"
          fi
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡ï¼ˆä»…å½“å·¥å…·é“¾å¯ç”¨æ—¶ï¼‰
          if [ "$CROSS_COMPILE_AVAILABLE" = "true" ]; then
            echo "=== è®¾ç½® ARM64 äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡ ==="
            echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
            echo "PKG_CONFIG_PATH_aarch64_unknown_linux_gnu=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
            echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
            echo "PKG_CONFIG_SYSROOT_DIR=/" >> $GITHUB_ENV
            echo "âœ… ARM64 äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡å·²è®¾ç½®"
          else
            echo "âš ï¸  è·³è¿‡ ARM64 äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡è®¾ç½®"
            echo "   å°†å›žé€€åˆ°ä¸»æœºæž¶æž„æž„å»º"
          fi
          
          # éªŒè¯äº¤å‰ç¼–è¯‘å·¥å…·é“¾
          echo "=== éªŒè¯äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ==="
          if aarch64-linux-gnu-gcc --version >/dev/null 2>&1; then
            echo "âœ… ARM64 GCC å¯ç”¨"
            aarch64-linux-gnu-gcc --version | head -1
            echo "CROSS_COMPILE_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "âŒ ARM64 GCC ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„æž„å»º"
            echo "CROSS_COMPILE_AVAILABLE=false" >> $GITHUB_ENV
          fi
          
          # éªŒè¯ ARM64 pkg-config æ–‡ä»¶ (å¦‚æžœå­˜åœ¨)
          echo "=== ARM64 ä¾èµ–éªŒè¯ ==="
          if [ -d "/usr/lib/aarch64-linux-gnu/pkgconfig/" ]; then
            echo "âœ… ARM64 pkgconfig ç›®å½•å­˜åœ¨"
            
            echo "=== ARM64 GLib éªŒè¯ ==="
            if ls /usr/lib/aarch64-linux-gnu/pkgconfig/ | grep -E "(glib|gobject|gio)" >/dev/null 2>&1; then
              echo "âœ… å‘çŽ° ARM64 GLib pkg-config æ–‡ä»¶"
              ls -la /usr/lib/aarch64-linux-gnu/pkgconfig/ | grep -E "(glib|gobject|gio)" | head -3
            else
              echo "âš ï¸  æœªå‘çŽ° ARM64 GLib pkg-config æ–‡ä»¶ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„"
            fi
            
            echo "=== ARM64 Tauri ä¾èµ–éªŒè¯ ==="
            if ls /usr/lib/aarch64-linux-gnu/pkgconfig/ | grep -E "(libsoup|javascriptcore)" >/dev/null 2>&1; then
              echo "âœ… å‘çŽ° ARM64 Tauri pkg-config æ–‡ä»¶"
              ls -la /usr/lib/aarch64-linux-gnu/pkgconfig/ | grep -E "(libsoup|javascriptcore)" | head -3
            else
              echo "âš ï¸  æœªå‘çŽ° ARM64 Tauri pkg-config æ–‡ä»¶ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„"
            fi
          else
            echo "âš ï¸  ARM64 pkgconfig ç›®å½•ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ä¸»æœºæž¶æž„é…ç½®"
            echo "   è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œäº¤å‰ç¼–è¯‘å°†ä½¿ç”¨ä¸»æœºæž¶æž„çš„å¤´æ–‡ä»¶"
          fi

      - name: Build duck-cli binary
        run: |
          # è®¾ç½®çŽ¯å¢ƒå˜é‡ (é’ˆå¯¹ä¸åŒæž¶æž„)
          if [[ "${{ matrix.platform.rust_target }}" == "x86_64-unknown-linux-gnu" ]]; then
            export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig"
            export PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1
            export PKG_CONFIG_ALLOW_SYSTEM_LIBS=1
          elif [[ "${{ matrix.platform.rust_target }}" == "aarch64-unknown-linux-gnu" ]]; then
            export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
            export PKG_CONFIG_ALLOW_CROSS=1
            export PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=1
            export PKG_CONFIG_ALLOW_SYSTEM_LIBS=1
            export PKG_CONFIG_SYSROOT_DIR=/
          fi
          
          # éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å¯ç”¨
          if [[ "${{ matrix.platform.os }}" == "ubuntu-22.04" ]]; then
            echo "=== æž„å»ºå‰éªŒè¯å…³é”®ä¾èµ– ==="
            echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
            pkg-config --exists glib-2.0 && echo "âœ… glib-2.0 available" || echo "âŒ glib-2.0 not found"
            pkg-config --exists gobject-2.0 && echo "âœ… gobject-2.0 available" || echo "âŒ gobject-2.0 not found"
            pkg-config --exists gio-2.0 && echo "âœ… gio-2.0 available" || echo "âŒ gio-2.0 not found"
            pkg-config --exists libsoup-3.0 && echo "âœ… libsoup-3.0 available" || echo "âŒ libsoup-3.0 not found"
            pkg-config --exists javascriptcoregtk-4.1 && echo "âœ… javascriptcoregtk-4.1 available" || echo "âŒ javascriptcoregtk-4.1 not found"
            
            # æµ‹è¯•å…³é”®åº“çš„ç¼–è¯‘æ ‡å¿—
            pkg-config --cflags glib-2.0 gobject-2.0 gio-2.0 2>/dev/null || echo "âŒ pkg-config cflags failed"
            pkg-config --libs glib-2.0 gobject-2.0 gio-2.0 2>/dev/null || echo "âŒ pkg-config libs failed"
            pkg-config --cflags libsoup-3.0 2>/dev/null || echo "âŒ libsoup-3.0 cflags failed"
            pkg-config --libs libsoup-3.0 2>/dev/null || echo "âŒ libsoup-3.0 libs failed"
            pkg-config --cflags javascriptcoregtk-4.1 2>/dev/null || echo "âŒ javascriptcoregtk-4.1 cflags failed"
            pkg-config --libs javascriptcoregtk-4.1 2>/dev/null || echo "âŒ javascriptcoregtk-4.1 libs failed"
          fi
          
          # åªæž„å»º duck-cli æ¨¡å—ï¼Œé¿å…å…¶ä»–æ¨¡å—çš„ä¾èµ–é—®é¢˜
          cargo build --release --target ${{ matrix.platform.rust_target }} -p duck-cli
        shell: bash

      - name: Copy duck-cli binary to cli-ui (Tauri sidecar naming)
        run: |
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p cli-ui/src-tauri/binaries
          
          # ä½¿ç”¨ Tauri è‡ªåŠ¨å‘½åçº¦å®šï¼šbinaries/duck-cli-$TARGET_TRIPLE
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            # Windows å¹³å° (.exe æ‰©å±•å)
            cp target/${{ matrix.platform.rust_target }}/release/duck-cli.exe \
               cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }}.exe
          else
            # macOS å’Œ Linux å¹³å° (æ— æ‰©å±•å)
            cp target/${{ matrix.platform.rust_target }}/release/duck-cli \
               cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }}
          fi
        shell: bash

      - name: Verify duck-cli binary
        run: |
          echo "=== éªŒè¯ duck-cli äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          find cli-ui/src-tauri/binaries -name "duck-cli*" -type f | head -10
          echo "=== äºŒè¿›åˆ¶æ–‡ä»¶åˆ—è¡¨ ==="
          ls -la cli-ui/src-tauri/binaries/
          
          echo "=== æµ‹è¯• duck-cli åŠŸèƒ½ ==="
          # æµ‹è¯•ç‰ˆæœ¬ä¿¡æ¯
          if [[ "${{ matrix.platform.os }}" == "windows-latest" ]]; then
            ./cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }}.exe --version || echo "âš ï¸ ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          else
            ./cli-ui/src-tauri/binaries/duck-cli-${{ matrix.platform.rust_target }} --version || echo "âš ï¸ ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          fi
        shell: bash

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          # æ ¹æ®ç›®æ ‡æž¶æž„è®¾ç½®æ­£ç¡®çš„ PKG_CONFIG_PATH
          PKG_CONFIG_PATH: ${{ matrix.platform.rust_target == 'x86_64-unknown-linux-gnu' && '/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig' || matrix.platform.rust_target == 'aarch64-unknown-linux-gnu' && '/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig' || '' }}
          PKG_CONFIG_ALLOW_CROSS: ${{ matrix.platform.rust_target == 'aarch64-unknown-linux-gnu' && '1' || '' }}
          PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
          PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1
          PKG_CONFIG_SYSROOT_DIR: ${{ matrix.platform.rust_target == 'aarch64-unknown-linux-gnu' && '/' || '' }}
          # ARM64 äº¤å‰ç¼–è¯‘é“¾æŽ¥å™¨ï¼ˆä»…å½“å·¥å…·é“¾å¯ç”¨æ—¶ï¼‰
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.platform.rust_target == 'aarch64-unknown-linux-gnu' && env.CROSS_COMPILE_AVAILABLE == 'true' && 'aarch64-linux-gnu-gcc' || '' }}
        with:
          projectPath: cli-ui
          args: --target ${{ matrix.platform.rust_target }} ${{ matrix.platform.build_args }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-ui-${{ matrix.platform.name }}
          path: |
            cli-ui/src-tauri/target/${{ matrix.platform.rust_target }}/release/bundle/
          retention-days: 30

  # macOS é€šç”¨äºŒè¿›åˆ¶æž„å»ºï¼ˆå¯é€‰ï¼‰
  build-macos-universal:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    needs: build
    if: ${{ always() && (needs.build.result == 'success') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            x86_64-apple-darwin
            aarch64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli-ui/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd cli-ui
          npm ci

      - name: Build duck-cli for macOS Universal
        run: |
          # æž„å»º x86_64 ç‰ˆæœ¬
          cargo build --release --target x86_64-apple-darwin -p duck-cli
          
          # æž„å»º aarch64 ç‰ˆæœ¬
          cargo build --release --target aarch64-apple-darwin -p duck-cli
          
          # åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä½¿ç”¨ Tauri å‘½åçº¦å®šï¼‰
          mkdir -p cli-ui/src-tauri/binaries
          lipo -create \
            target/x86_64-apple-darwin/release/duck-cli \
            target/aarch64-apple-darwin/release/duck-cli \
            -output cli-ui/src-tauri/binaries/duck-cli-universal-apple-darwin

      - name: Build universal macOS app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          projectPath: cli-ui
          args: --target universal-apple-darwin

      - name: Upload universal macOS build
        uses: actions/upload-artifact@v4
        with:
          name: cli-ui-macOS-universal
          path: |
            cli-ui/src-tauri/target/universal-apple-darwin/release/bundle/
          retention-days: 30

  # æž„å»ºæ‘˜è¦
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check, build, build-macos-universal]
    if: ${{ always() }}
    steps:
      - name: Generate build summary
        run: |
          echo "## CLI-UI Build Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-build checks: ${{ needs.check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-platform build: ${{ needs.build.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS Universal build: ${{ needs.build-macos-universal.result == 'success' && 'âœ… Completed' || needs.build-macos-universal.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Supported Platforms" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux (x86_64, ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows (x86_64, ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ macOS (x86_64, ARM64, Universal)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Built applications can be found in the **Artifacts** section of this workflow run." >> $GITHUB_STEP_SUMMARY

          # å¦‚æžœæž„å»ºå¤±è´¥ï¼Œæ·»åŠ æ•…éšœæŽ’é™¤ä¿¡æ¯
          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "- Check that all duck-cli binaries were downloaded correctly" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Tauri configuration is valid" >> $GITHUB_STEP_SUMMARY
            echo "- Ensure all system dependencies are installed" >> $GITHUB_STEP_SUMMARY
            echo "- Check for Rust compilation errors" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ” ARM64 Network Issues" >> $GITHUB_STEP_SUMMARY
            echo "å¦‚æžœé‡åˆ° ARM64 åŒ…ä¸‹è½½ 404 é”™è¯¯ï¼š" >> $GITHUB_STEP_SUMMARY
            echo "- è¿™é€šå¸¸æ˜¯ Ubuntu å®‰å…¨æœåŠ¡å™¨çš„ä¸´æ—¶é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "- æž„å»ºç³»ç»Ÿå·²é…ç½®ä¸ºè‡ªåŠ¨å›žé€€åˆ°ä¸»æœºæž¶æž„" >> $GITHUB_STEP_SUMMARY
            echo "- å¯ä»¥ç¨åŽé‡è¯•æž„å»ºï¼Œæˆ–è€…æš‚æ—¶ç¦ç”¨ ARM64 æž„å»º" >> $GITHUB_STEP_SUMMARY
            echo "- ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä»å¯åœ¨ ARM64 ç³»ç»Ÿä¸Šè¿è¡Œï¼ˆé€šè¿‡ä»¿çœŸï¼‰" >> $GITHUB_STEP_SUMMARY
          fi 